{% extends "base.html" %}
{% block title %}Admin Dashboard — CharacterForge{% endblock %}
{% block content %}
<h1>Admin Dashboard</h1>
<p class="subtitle">Manage users, roles, campaigns, and system settings.</p>

<!-- Stats -->
<div class="cards-grid" style="grid-template-columns: repeat(3, 1fr); max-width: 600px; margin-bottom: 28px;">
  <div class="panel" style="text-align:center">
    <div style="font-size:32px;font-family:'Cinzel',serif;color:var(--gold)">{{ user_count }}</div>
    <div class="text-dim">Users</div>
  </div>
  <div class="panel" style="text-align:center">
    <div style="font-size:32px;font-family:'Cinzel',serif;color:var(--gold)">{{ campaign_count }}</div>
    <div class="text-dim">Campaigns</div>
  </div>
  <div class="panel" style="text-align:center">
    <div style="font-size:32px;font-family:'Cinzel',serif;color:var(--gold)">{{ char_count }}</div>
    <div class="text-dim">Characters</div>
  </div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start">

<!-- User Management -->
<div>
  <div class="panel panel-gold">
    <h2>Create User</h2>
    <form method="post" action="/admin/users/create">
      <label>Username</label>
      <input type="text" name="username" required>
      <label>Display Name</label>
      <input type="text" name="display_name" placeholder="Optional">
      <label>Password</label>
      <input type="password" name="password" required>
      <label>Role</label>
      <select name="role">
        <option value="player">Player</option>
        <option value="dm">Dungeon Master</option>
        <option value="admin">Admin</option>
      </select>
      <button type="submit" class="btn btn-primary btn-sm" style="margin-top:14px">Create User</button>
    </form>
  </div>

  <div class="panel">
    <h2>All Users</h2>
    <table class="data-table">
      <tr><th>User</th><th>Role</th><th>Actions</th></tr>
      {% for u in users %}
      <tr>
        <td>
          <div style="font-weight:600;color:var(--text-bright)">{{ u.display_name or u.username }}</div>
          <div style="font-size:12px;color:var(--text-dim)">@{{ u.username }}</div>
        </td>
        <td><span class="badge badge-{{ u.role }}">{{ u.role }}</span></td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="openModal('modal-role-{{ u.id }}')">Role</button>
          <button class="btn btn-sm btn-secondary" onclick="openModal('modal-pw-{{ u.id }}')">PW</button>
          {% if u.id != session.get('user_id') %}
          <form method="post" action="/admin/users/{{ u.id }}/delete" class="confirm-action" data-confirm="Delete user {{ u.username }}? This cannot be undone." style="display:inline">
            <button type="submit" class="btn btn-sm btn-danger">Del</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>

<!-- Campaigns -->
<div>
  <div class="panel panel-gold">
    <h2>Campaigns</h2>
    {% if campaigns %}
    <table class="data-table">
      <tr><th>Campaign</th><th>DM</th><th>Actions</th></tr>
      {% for c in campaigns %}
      <tr>
        <td>
          <a href="/campaigns/{{ c.id }}" style="color:var(--gold-light)">{{ c.name }}</a>
        </td>
        <td style="font-size:13px;color:var(--text-dim)">{{ c.dm.display_name or c.dm.username if c.dm else '—' }}</td>
        <td>
          <form method="post" action="/admin/campaigns/{{ c.id }}/delete" class="confirm-action" data-confirm="Delete campaign '{{ c.name }}'? All characters in it will be deleted." style="display:inline">
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
      <p class="text-dim">No campaigns yet. DMs create campaigns from their dashboard.</p>
    {% endif %}
  </div>
</div>

</div>

<!-- Role modals -->
{% for u in users %}
<div class="modal-overlay" id="modal-role-{{ u.id }}">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-role-{{ u.id }}')">✕</button>
    <h2>Change Role — {{ u.username }}</h2>
    <form method="post" action="/admin/users/{{ u.id }}/set_role">
      <label>New Role</label>
      <select name="role">
        <option value="player" {% if u.role=='player' %}selected{% endif %}>Player</option>
        <option value="dm" {% if u.role=='dm' %}selected{% endif %}>Dungeon Master</option>
        <option value="admin" {% if u.role=='admin' %}selected{% endif %}>Admin</option>
      </select>
      <button type="submit" class="btn btn-primary">Save Role</button>
    </form>
  </div>
</div>

<div class="modal-overlay" id="modal-pw-{{ u.id }}">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-pw-{{ u.id }}')">✕</button>
    <h2>Reset Password — {{ u.username }}</h2>
    <form method="post" action="/admin/users/{{ u.id }}/reset_password">
      <label>New Password</label>
      <input type="password" name="password" required placeholder="Min 6 characters">
      <button type="submit" class="btn btn-primary">Set Password</button>
    </form>
  </div>
</div>
{% endfor %}

{% endblock %}
